<?xml version="1.0" ?>

<Problem>

  <Solvers>
    <CompositionalMultiphaseReservoir
      name="coupledFlowAndWells"
      flowSolverName="compositionalMultiphaseFlow"
      wellSolverName="compositionalMultiphaseWell"
      logLevel="1"
      initialDt="1"
      targetRegions="{ reservoir1, reservoir2, reservoir3, reservoir4, reservoir5, reservoir6, reservoir7, wellRegion1, wellRegion2 }">
      <NonlinearSolverParameters
        newtonTol="1.0e-3"
        maxTimeStepCuts="10"
        maxSubSteps="20"
        newtonMaxIter="40"/>
      <LinearSolverParameters
        solverType="fgmres"
        preconditionerType="mgr"
        krylovTol="1e-4"
        logLevel="1"/>
    </CompositionalMultiphaseReservoir>

    <CompositionalMultiphaseFVM
      name="compositionalMultiphaseFlow"
      targetRegions="{ reservoir1, reservoir2, reservoir3, reservoir4, reservoir5, reservoir6, reservoir7 }"
      discretization="fluidTPFA"
      temperature="293.15"
      maxCompFractionChange="0.2"
      targetPhaseVolFractionChangeInTimeStep="0.05"      
      logLevel="1"
      useMass="1"/>

    <CompositionalMultiphaseWell
      name="compositionalMultiphaseWell"
      targetRegions="{ wellRegion1, wellRegion2 }"
      logLevel="1"
      useMass="1">
      <WellControls
        name="wellControls1"
        type="injector"
        logLevel="1"
        control="totalVolRate"
        referenceElevation="-1"
        targetBHP="1e8"
        enableCrossflow="0"
        useSurfaceConditions="1"
        surfacePressure="101325"
        surfaceTemperature="293.71"
        targetTotalRateTableName="totalRateTable1"
        injectionTemperature="293.15"
        injectionStream="{ 1.0, 0.0 }"/>
      <WellControls
        name="wellControls2"
        type="injector"
        logLevel="1"
        control="totalVolRate"
        referenceElevation="-.6"
        targetBHP="1e8"
        enableCrossflow="0"
        useSurfaceConditions="1"
        surfacePressure="101325"
        surfaceTemperature="293.71"
        targetTotalRateTableName="totalRateTable2"
        injectionTemperature="293.15"
        injectionStream="{ 1.0, 0.0 }"/>
    </CompositionalMultiphaseWell>
  </Solvers>
  
  <ElementRegions>
    <CellElementRegion
      name="reservoir1"
      cellBlocks="{ 1_hexahedra }"
      materialList="{ fluid, rock, relperm1, cappres1, diffusion }"/>
    <CellElementRegion
      name="reservoir2"
      cellBlocks="{ 2_hexahedra }"
      materialList="{ fluid, rock, relperm2, cappres2, diffusion }"/>
    <CellElementRegion
      name="reservoir3"
      cellBlocks="{ 3_hexahedra }"
      materialList="{ fluid, rock, relperm3, cappres3, diffusion }"/>
    <CellElementRegion
      name="reservoir4"
      cellBlocks="{ 4_hexahedra }"
      materialList="{ fluid, rock, relperm4, cappres4, diffusion }"/>
    <CellElementRegion
      name="reservoir5"
      cellBlocks="{ 5_hexahedra }"
      materialList="{ fluid, rock, relperm5, cappres5, diffusion }"/>
    <CellElementRegion
      name="reservoir6"
      cellBlocks="{ 6_hexahedra }"
      materialList="{ fluid, rock, relperm6, cappres6, diffusion }"/>
    <CellElementRegion
      name="reservoir7"
      cellBlocks="{ 7_hexahedra }"
      materialList="{ fluid, rock, relperm7, cappres7, noDiffusion }"/>

    <WellElementRegion
      name="wellRegion1"
      materialList="{ fluid, relperm5 }"/>
    <WellElementRegion
      name="wellRegion2"
      materialList="{ fluid, relperm5 }"/>
  </ElementRegions>
 
  <NumericalMethods>
    <FiniteVolume>
      <TwoPointFluxApproximation
        name="fluidTPFA" />
    </FiniteVolume>
  </NumericalMethods>

  <Constitutive>
    <CO2BrinePhillipsFluid
      name="fluid"
      phaseNames="{ gas, water }"
      componentNames="{ co2, water }"
      componentMolarWeight="{ 44e-3, 18e-3 }"
      phasePVTParaFiles="{ tables_spe11a/pvtgas.txt, tables_spe11a/pvtliquid.txt }"
      flashModelParaFile="tables_spe11a/co2flash.txt"/>

    <CompressibleSolidConstantPermeability
      name="rock"
      solidModelName="nullSolid"
      porosityModelName="rockPorosity"
      permeabilityModelName="rockPerm"/>
    <NullModel
      name="nullSolid"/>
    <PressurePorosity
      name="rockPorosity"
      defaultReferencePorosity="0.1"
      referencePressure="1.0e5"
      compressibility="4.5e-17"/>
    <ConstantPermeability
      name="rockPerm"
      permeabilityComponents="{ 1.0e-12, 1.0e-12, 1.0e-12 }"/>

    <!-- Problem 3.2 is hysteretical only --> 

    <!-- kr per facies -->
    <BrooksCoreyRelativePermeability
      name="relperm1"
      phaseNames="{ gas, water }"
      phaseMinVolumeFraction="{ 0.1, 0.32 }"
      phaseRelPermExponent="{ 2.0, 2.0 }"
      phaseRelPermMaxValue="{ 1.0, 1.0 }"/>
    <BrooksCoreyRelativePermeability
      name="relperm2"
      phaseNames="{ gas, water }"
      phaseMinVolumeFraction="{ 0.1, 0.14 }"
      phaseRelPermExponent="{ 2.0, 2.0 }"
      phaseRelPermMaxValue="{ 1.0, 1.0 }"/>
    <BrooksCoreyRelativePermeability
      name="relperm3"
      phaseNames="{ gas, water }"
      phaseMinVolumeFraction="{ 0.1, 0.12 }"
      phaseRelPermExponent="{ 2.0, 2.0 }"
      phaseRelPermMaxValue="{ 1.0, 1.0 }"/>
    <BrooksCoreyRelativePermeability
      name="relperm4"
      phaseNames="{ gas, water }"
      phaseMinVolumeFraction="{ 0.1, 0.12 }"
      phaseRelPermExponent="{ 2.0, 2.0 }"
      phaseRelPermMaxValue="{ 1.0, 1.0 }"/>
    <BrooksCoreyRelativePermeability
      name="relperm5"
      phaseNames="{ gas, water }"
      phaseMinVolumeFraction="{ 0.1, 0.12 }"
      phaseRelPermExponent="{ 2.0, 2.0 }"
      phaseRelPermMaxValue="{ 1.0, 1.0 }"/>
    <BrooksCoreyRelativePermeability
      name="relperm6"
      phaseNames="{ gas, water }"
      phaseMinVolumeFraction="{ 0.1, 0.10 }"
      phaseRelPermExponent="{ 2.0, 2.0 }"
      phaseRelPermMaxValue="{ 1.0, 1.0 }"/>
    <!-- impermeable model -->
    <BrooksCoreyRelativePermeability
      name="relperm7"
      phaseNames="{ gas, water }"
      phaseMinVolumeFraction="{ 0.1, .1 }"
      phaseRelPermExponent="{ 2.0, 2.0 }"
      phaseRelPermMaxValue="{ 0.0001, 0.0001 }"/>
    
    <ConstantDiffusion
      name="diffusion"
      phaseNames="{ gas, water }"
      defaultPhaseDiffusivityMultipliers="{ 16000, 1 }"
      diffusivityComponents="{ 1e-9, 1e-9, 1e-9 }"/>
    <ConstantDiffusion
      name="noDiffusion"
      phaseNames="{ gas, water }"
      defaultPhaseDiffusivityMultipliers="{ 0, 0 }"
      diffusivityComponents="{ 0, 0, 0 }"/>
    
    <!-- cap per facies -->
    <BrooksCoreyCapillaryPressure
      name="cappres1"
      phaseNames="{ gas, water }"
      capPressureEpsilon="1e-3"
      phaseCapPressureExponentInv="{1., 2}"
      phaseEntryPressure="{ 0., 1500 }"
      phaseMinVolumeFraction="{ 0.1, 0.32 }" />
    <BrooksCoreyCapillaryPressure
      name="cappres2"
      phaseNames="{ gas, water }"
      capPressureEpsilon="1e-3"
      phaseCapPressureExponentInv="{1., 2}"
      phaseEntryPressure="{ 0., 300 }"
      phaseMinVolumeFraction="{ 0.1, 0.14 }" />
    <BrooksCoreyCapillaryPressure
      name="cappres3"
      phaseNames="{ gas, water }"
      capPressureEpsilon="1e-3"
      phaseCapPressureExponentInv="{1., 2}"
      phaseEntryPressure="{ 0., 100 }"
      phaseMinVolumeFraction="{ 0.1, 0.12 }" />
    <BrooksCoreyCapillaryPressure
      name="cappres4"
      phaseNames="{ gas, water }"
      capPressureEpsilon="1e-3"
      phaseCapPressureExponentInv="{1., 2}"
      phaseEntryPressure="{ 0., 25 }"
      phaseMinVolumeFraction="{ 0.1, 0.12 }" />
    <BrooksCoreyCapillaryPressure
      name="cappres5"
      phaseNames="{ gas, water }"
      capPressureEpsilon="1e-3"
      phaseCapPressureExponentInv="{1., 2}"
      phaseEntryPressure="{ 0., 10 }"
      phaseMinVolumeFraction="{ 0.1, 0.12 }" />
    <BrooksCoreyCapillaryPressure
      name="cappres6"
      phaseNames="{ gas, water }"
      capPressureEpsilon="1e-3"
      phaseCapPressureExponentInv="{1., 2}"
      phaseEntryPressure="{ 0., 1 }"
      phaseMinVolumeFraction="{ 0.1, 0.1 }" />
    <BrooksCoreyCapillaryPressure
      name="cappres7"
      phaseNames="{ gas, water }"
      capPressureEpsilon="1e-3"
      phaseCapPressureExponentInv="{1., 2}"
      phaseEntryPressure="{0., 0}"
      phaseMinVolumeFraction="{ 0.1, 0.12 }" />

    <!-- cap per facies       -->
    <!-- <TableCapillaryPressure -->
    <!--   name="cappres1" -->
    <!--   phaseNames="{ gas, water }" -->
    <!--   wettingNonWettingCapPressureTableName="cappresTable1"/> -->
    <!-- <TableCapillaryPressure -->
    <!--   name="cappres2" -->
    <!--   phaseNames="{ gas, water }" -->
    <!--   wettingNonWettingCapPressureTableName="cappresTable2"/> -->
    <!-- <TableCapillaryPressure -->
    <!--   name="cappres3" -->
    <!--   phaseNames="{ gas, water }" -->
    <!--   wettingNonWettingCapPressureTableName="cappresTable3"/> -->
    <!-- <TableCapillaryPressure -->
    <!--   name="cappres4" -->
    <!--   phaseNames="{ gas, water }" -->
    <!--   wettingNonWettingCapPressureTableName="cappresTable4"/> -->
    <!-- <TableCapillaryPressure -->
    <!--   name="cappres5" -->
    <!--   phaseNames="{ gas, water }" -->
    <!--   wettingNonWettingCapPressureTableName="cappresTable5"/> -->
    <!-- <TableCapillaryPressure -->
    <!--   name="cappres6" -->
    <!--   phaseNames="{ gas, water }" -->
    <!--   wettingNonWettingCapPressureTableName="cappresTable6"/> -->
    <!-- <TableCapillaryPressure -->
    <!--   name="cappres7" -->
    <!--   phaseNames="{ gas, water }" -->
    <!--   wettingNonWettingCapPressureTableName="cappresTable7"/> -->

  </Constitutive>

  <FieldSpecifications>
    <HydrostaticEquilibrium
      name="equil"
      objectPath="ElementRegions/reservoir*"
      datumElevation="0"
      datumPressure="1.1e5"
      initialPhaseName="water"
      componentNames="{ co2, water }"
      componentFractionVsElevationTableNames="{ initCO2CompFracTable,
                                              initWaterCompFracTable }"
      temperatureVsElevationTableName="initTempTable"/>

  <FieldSpecification
      name="topTemperature"
      objectPath="faceManager"
      fieldName="temperature"
      scale="293.15"
      setNames="{ top }"/>
  <FieldSpecification
      name="topPressure"
      objectPath="faceManager"
      fieldName="pressure"
      scale="1.1e5"
      setNames="{ top }"/>
    <FieldSpecification
      name="BCComposition_gas"
      setNames="{ top }"
      objectPath="faceManager"
      fieldName="globalCompFraction"
      component="0"
      scale="0.0"/>
    <FieldSpecification
      name="BCComposition_water"
      setNames="{ top }"
      objectPath="faceManager"
      fieldName="globalCompFraction"
      component="1"
      scale="1.0"/>

    <FieldSpecification
      name="permx1"
      initialCondition="1"
      component="0"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir1"
      fieldName="rockPerm_permeability"
      scale="4e-11"/>
    <FieldSpecification
      name="permy1"
      initialCondition="1"
      component="1"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir1"
      fieldName="rockPerm_permeability"
      scale="4e-11"/>
    <FieldSpecification
      name="permz1"
      initialCondition="1"
      component="2"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir1"
      fieldName="rockPerm_permeability"
      scale="4e-11"/>

    <FieldSpecification
      name="permx2"
      initialCondition="1"
      component="0"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir2"
      fieldName="rockPerm_permeability"
      scale="5e-10"/>
    <FieldSpecification
      name="permy2"
      initialCondition="1"
      component="1"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir2"
      fieldName="rockPerm_permeability"
      scale="5e-10"/>
    <FieldSpecification
      name="permz2"
      initialCondition="1"
      component="2"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir2"
      fieldName="rockPerm_permeability"
      scale="5e-10"/>
    
    <FieldSpecification
      name="permx3"
      initialCondition="1"
      component="0"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir3"
      fieldName="rockPerm_permeability"
      scale="1e-9"/>
    <FieldSpecification
      name="permy3"
      initialCondition="1"
      component="1"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir3"
      fieldName="rockPerm_permeability"
      scale="1e-9"/>
    <FieldSpecification
      name="permz3"
      initialCondition="1"
      component="2"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir3"
      fieldName="rockPerm_permeability"
      scale="1e-9"/>
    
    <FieldSpecification
      name="permx4"
      initialCondition="1"
      component="0"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir4"
      fieldName="rockPerm_permeability"
      scale="2e-9"/>
    <FieldSpecification
      name="permy4"
      initialCondition="1"
      component="1"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir4"
      fieldName="rockPerm_permeability"
      scale="2e-9"/>
    <FieldSpecification
      name="permz4"
      initialCondition="1"
      component="2"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir4"
      fieldName="rockPerm_permeability"
      scale="2e-9"/>
    
    <FieldSpecification
      name="permx5"
      initialCondition="1"
      component="0"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir5"
      fieldName="rockPerm_permeability"
      scale="4e-9"/>
    <FieldSpecification
      name="permy5"
      initialCondition="1"
      component="1"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir5"
      fieldName="rockPerm_permeability"
      scale="4e-9"/>
    <FieldSpecification
      name="permz5"
      initialCondition="1"
      component="2"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir5"
      fieldName="rockPerm_permeability"
      scale="4e-9"/>
    
    <FieldSpecification
      name="permx6"
      initialCondition="1"
      component="0"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir6"
      fieldName="rockPerm_permeability"
      scale="1e-8"/>
    <FieldSpecification
      name="permy6"
      initialCondition="1"
      component="1"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir6"
      fieldName="rockPerm_permeability"
      scale="1e-8"/>
    <FieldSpecification
      name="permz6"
      initialCondition="1"
      component="2"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir6"
      fieldName="rockPerm_permeability"
      scale="1e-8"/>
    
    <FieldSpecification
      name="permx7"
      initialCondition="1"
      component="0"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir7"
      fieldName="rockPerm_permeability"
      scale="1e-26"/>
    <FieldSpecification
      name="permy7"
      initialCondition="1"
      component="1"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir7"
      fieldName="rockPerm_permeability"
      scale="1e-26"/>
    <FieldSpecification
      name="permz7"
      initialCondition="1"
      component="2"
      setNames="{ all }"
      objectPath="ElementRegions/reservoir7"
      fieldName="rockPerm_permeability"
      scale="1e-26"/>
    
  </FieldSpecifications>

  <Functions>
    <TableFunction
      name="initCO2CompFracTable"
      coordinates="{ -1.3 , 0}"
      values="{ 0.000001, 0.000001 }"/>
    <TableFunction
      name="initWaterCompFracTable"
      coordinates="{ -1.3 , 0}"
      values="{ 0.999999, 0.999999 }"/>
    <TableFunction
      name="initTempTable"
      coordinates="{ -1.3 , 0}"
      values="{ 293.15, 293.15 }"/>

    <TableFunction
      name="totalRateTable1"
      inputVarNames="{time}"
      coordinates="{0, 9000,18000, 18001, 432000}"
      values="{ 9.2597479e-8, 9.2597479e-8, 9.2597479e-8, 0., 0}"
      interpolation="lower"/>
    <TableFunction
      name="totalRateTable2"
      inputVarNames="{time}"
      coordinates="{0, 8999, 9000, 18000, 18001, 432000}"
      values="{0, 0, 9.2597479e-8, 9.2597479e-8, 0, 0}"
      interpolation="lower"/>
    
    <TableFunction
      name="cappresTable1"
      coordinateFiles="{ tables_spe11a/waterPCSaturation_spe11a_1.txt}"
      voxelFile="tables_spe11a/waterCapPres_spe11a_1.txt" />
    <TableFunction
      name="cappresTable2"
      coordinateFiles="{ tables_spe11a/waterPCSaturation_spe11a_2.txt}"
      voxelFile="tables_spe11a/waterCapPres_spe11a_2.txt" />
    <TableFunction
      name="cappresTable3"
      coordinateFiles="{ tables_spe11a/waterPCSaturation_spe11a_3.txt}"
      voxelFile="tables_spe11a/waterCapPres_spe11a_3.txt" />
    <TableFunction
      name="cappresTable4"
      coordinateFiles="{ tables_spe11a/waterPCSaturation_spe11a_4.txt}"
      voxelFile="tables_spe11a/waterCapPres_spe11a_4.txt" />
    <TableFunction
      name="cappresTable5"
      coordinateFiles="{ tables_spe11a/waterPCSaturation_spe11a_5.txt}"
      voxelFile="tables_spe11a/waterCapPres_spe11a_5.txt" />
    <TableFunction
      name="cappresTable6"
      coordinateFiles="{ tables_spe11a/waterPCSaturation_spe11a_6.txt}"
      voxelFile="tables_spe11a/waterCapPres_spe11a_6.txt" />
    <TableFunction
      name="cappresTable7"
      coordinateFiles="{ tables_spe11a/waterPCSaturation_spe11a_7.txt}"
      voxelFile="tables_spe11a/waterCapPres_spe11a_7.txt" />

  </Functions>

  <Geometry>
    <Box
      name="top"
      xMin="{ -0.01, -0.01, -0.013 }"
      xMax="{ 2.81, 0.02, -0.01 }"/>
  </Geometry>

  <Tasks>
    <CompositionalMultiphaseStatistics
      name="compflowStatistics"
      flowSolverName="compositionalMultiphaseFlow"
      logLevel="1"
      computeCFLNumbers="1"
      computeRegionStatistics="1"/>
  </Tasks>

  <Outputs>
    <VTK
      name="vtkOutput"/>
    <Restart
      name="restartOutput"/>
  </Outputs>

</Problem>
